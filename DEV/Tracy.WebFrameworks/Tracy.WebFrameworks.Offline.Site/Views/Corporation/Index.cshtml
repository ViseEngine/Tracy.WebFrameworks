
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <link type="image/x-icon" rel="shortcut icon" href="~/Content/images/favicon.ico" />
    @Styles.Render("~/Content/easyui/bootstrap")
    @Styles.Render("~/Content/site")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/easyui")
    @Scripts.Render("~/bundles/common")
    <title>公司管理</title>
</head>
<body>
    <div id="ui_corp_layout" class="easyui-layout" data-options="fit:true,border:false">
        <div data-options="region:'north',split:true,border:true,collapsed:false" title="搜索条件" style="height:72px;">
            <table id="ui_role_search" class="tableForm" style="height: 28px; background: #f5f5f5;">
                <tr>
                    <th height="20px">
                        公司名称：
                    </th>
                    <td>
                        <input name="txtSearchRoleName" id="txtSearchRoleName" class="easyui-validatebox textbox" style="width:150px;height:22px;" />
                    </td>
                    <td>
                        <a href="javascript:void(0);" class="easyui-linkbutton" iconcls="icon-search" plain="true"
                           onclick="searchdata();">搜索</a>
                    </td>
                </tr>
            </table>
        </div>
        <div data-options="region:'east',split:true,border:true,collapsed:true" title="公司部门"
             style="width: 480px;">
            <table id="ui_corp_depart_dg" data-options="fit:true,border:false"></table>
        </div>
        <div data-options="region:'center',border:false">
            <table id="ui_corp_tg" data-options="fit:true,border:false"></table>
        </div>
    </div>

    @if (false)
    {
        <script type="text/javascript" src="~/Scripts/jquery-1.8.2.js"></script>
    }

    <script type="text/javascript">
        $(function () {
            //请求当前用户可以操作的按钮
            $.ajax({
                url: '@Url.Action("GetButtonByUserIdAndMenuCode", "Button")',
                type: "POST",
                dataType: "json",
                data: { "menuCode": "corp", "pageName": "corporation" },
                timeout: 5000,
                success: function (data) {
                    if (data.success) {
                        var oldSelectCorpId;
                        var toolbar = getToolBar(data);
                        if (data.browser) {
                            $("#ui_corp_tg").treegrid({
                                url: '@Url.Action("GetAll", "Corporation")',
                                idField: 'id',
                                treeField: 'text',
                                rownumbers: true,
                                columns: [[
                                            { field: 'text', title: '公司名称', width: 250 },
                                            { field: 'Code', title: '编码', width: 150 },
                                            { field: 'Sort', title: '排序', width: 50 },
                                            { field: 'CreatedTime', title: '创建时间', width: 150 }
                                ]],
                                toolbar: toolbar.length == 0 ? null : toolbar,
                                onClickRow: function (row) {
                                    corpIds = "";
                                    recursionGetIds(row);//递归获取所有子公司id 
                                    if (oldSelectCorpId == row.id) {
                                        return;
                                    }
                                    oldSelectCorpId = row.id;

                                    var $ui_department_layout = $("#ui_corp_layout");
                                    var eastDepartmentUser = $ui_department_layout.layout("panel", "east");

                                    if (eastDepartmentUser.panel("options").collapsed) {
                                        $ui_department_layout.layout("expand", "east");
                                    }
                                    eastDepartmentUser.panel("setTitle", row.text + "成员");
                                    if ($("#ui_corp_depart_dg").data("datagrid")) {
                                        $("#ui_corp_depart_dg").datagrid({
                                            url:'@Url.Action("GetCorpDepartment", "Corporation")'
                                        });
                                    }
                                    else {
                                        $("#ui_corp_depart_dg").datagrid({
                                            //url: "ashx/bg_department.ashx?action=searchDepartmentUser&departmentId=" + corpIds + row.id,
                                            url: "@Url.Action("GetCorpDepartment", "Corporation")",
                                            striped: true, rownumbers: true, pagination: true, pageSize: 20, singleSelect: true,
                                            idField: 'Id',
                                            sortName: 'AddDate',
                                            sortOrder: 'asc',
                                            pageList: [20, 40, 60, 80, 100],
                                            columns: [[
                                                  { field: 'UserId', title: '部门名称', sortable: true, width: 100 },
                                                  { field: 'UserName', title: '编码', sortable: true, width: 80 },
                                                  {
                                                      field: 'IsAble', title: '启用', sortable: true, width: 60, align: 'center',
                                                      formatter: function (value, row, index) {
                                                          return value ? '<img src="themes/icon/chk_checked.gif" alt="已启用" title="用户已启用" />' : '<img src="themes/icon/chk_unchecked.gif" alt="未启用" title="用户未启用" />';
                                                      }
                                                  },
                                                  { field: 'CreatedTime', title: '创建时间', sortable: true, width: 130 }]]
                                        });
                                    }
                                }
                            });
                        }
                        else {
                            $("#ui_corp_layout").layout("remove", "east");
                            $.show_warning("提示", "无权限，请联系管理员！");
                        }
                    } else {
                        $.show_warning("错误", data.result);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    if (textStatus == "timeout") {
                        $.show_warning("提示", "请求超时，请刷新当前页重试！");
                    }
                    else {
                        $.show_warning("错误", textStatus + "：" + errorThrown);
                    }
                }
            })
        });

        var corpIds = "";
        function recursionGetIds(rows) {
            if (rows.children != undefined) {
                $.each(rows.children, function (i, row) {
                    corpIds += row.id + ",";
                    recursionGetIds(row);
                });
            }
        }

    </script>

</body>
</html>
